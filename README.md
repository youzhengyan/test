# 电子发票接口文档

---

# 1 发票开具

### 功能说明

提供发票开具功能。

### 请求地址

```
/invoice/makeOut
```

### 接口方式

表单请求(POST)，JSON应答，字符集为UTF-8。

### 请求参数

| 参数             | 参数名称           | 类型（最大长度） | 参数说明                       | 是否可空 | 描述                                                         |
| ---------------- | ------------------ | ---------------- | ------------------------------ | -------- | ------------------------------------------------------------ |
| mer_order_id     | 商户请求单号       | String(64)       | 销售方发票开票订单号           | 不可空   | 如：`mer_order_id=20110101XX`                                |
| mer_code         | 商户编号           | String(32)       | 奇虎分配给商户的ID号码         | 不可空   | 如：`mer_code=201111360`。                                   |
| apply_time       | 时间戳             | Number           | 开票申请时间戳                 | 不可空   | Unix timestamp，超时时间为86400。                            |
| invoice_title    | 发票抬头           | String(100)      | 购买方名称 开票 纳税人名称     | 可空     | 如：`invoice_title=XX烟草公司`<br>如为非收购发票，为购 买方名称;如为收购发 票，此项必填，即开票 纳税人名称 |
| tax_type         | 征税方式           | Number           | 征税方式                       | 不可空   | 如：`0`-普通征税；`1`-减按计征；`2`-差额征税                 |
| tax_register_no  | 购买方纳税人识别号 | String(20)       | 购买方纳税人识别号             | 可空     | 如果不为空必须为 15-20 位数字或字母， 不能全为 0。 如为非收购发票，且收票方为企业时此项必填;如为收购发票，此项必填，即开票方纳税人识别号 |
| user_id          | 购买方ID           | String(64)       | 购买方ID                       | 可空     | 360用户QID或小程序对应UnionID或OpenID                        |
| user_type        | 用户类型           | Number           | 用户类型                       | 可空     | 如： `0`-360用户；`1`-小程序用户；                           |
| total_price      | 合计金额           | String(12)       | 合计金额 不含税金额            | 不可空   | 不含税，单位:元(最 多保留 2 位小数)                          |
| total_tax_price  | 合计税额           | String(12)       | 合计税额                       | 不可空   | 单位:元(2 位小数)                                            |
| total_price_tax  | 价税合计           | String(12)       | 价税合计                       | 不可空   | 单位:元(最多保留 2 位小数)                                   |
| mer_trade_code   | 商户支付订单号     | String(32)       | 原在支付中心支付的订单号       | 可空     | 多笔订单以`,`分隔                                            |
| third_trade_code | 第三方业务订单号   | String(64)       | 第三方业务订单号               | 可空     | 多笔订单以`,`分隔。蓝字发票选填，红字发票为空。开蓝字发票时，如果交易订单不是走支付中心，则最好上送该字段。 |
| address_phone    | 地址、电话         | String(100)      | 购买方地址、电话               | 可空     | 如：`北京市朝阳区酒仙桥路甲10号3号楼15层17层1701-10A 58781000` |
| bank_name        | 银行名称           | String(64)       | 银行名称                       | 可空     | 如：`招商银行北京建国路支行`                                 |
| bank_account     | 银行账号           | String(32)       | 银行账号                       | 可空     | 如：`110919397110902`                                        |
| user_email       | 电子邮箱           | String(64)       | 用于接收电子发票的电子邮箱     | 可空     |                                                              |
| receive_phone    | 手机号码           | String(20)       | 用于接收电子发票短信的手机号码 | 可空     |                                                              |
| deduction_price  | 扣除额             | String(12)       | 扣除额                         | 可空     | 最多保留至小数点后 2 位，征税方式为`差额征税`时，必填        |
| remarks          | 备注               | String(160)      | 备注                           | 可空     |                                                              |
| industry_type    | 行业类型           | Number           | 行业类型                       | 可空     | 行业类型 `0` - 商业、`1` - 其它                              |
|                  |                    |                  |                                |          |                                                              |
| + item_details   | 开票明细           |                  | 开票明细                       | 不可空   | 最多不超过8个json对象<br>如：`item_details=[{"nature":"0","product_code":"1010101030000000000","name":"谷物","price_tax":"5","price":"4.7","tax_rate":"0.06","tax_price":"0.3"}]` |
| - nature         | 发票行性质         | Number           | 发票行性质                     | 不可空   | `0`-正常行；`1`-折扣行；`2`-被折扣行                         |
| - name           | 项目名称           | String(90)       | 项目名称                       | 不可空   | 如果为折扣行，商品名 称须与被折扣行的商 品名称相同，不能多行 折扣。 |
| - price_tax      | 价税合计           | String(12)       | 单条价税合计                   | 不可空   | 单位:元(最多保留 2 位小数)                                   |
| - price          | 合计金额           | String(12)       | 不含税金额                     | 不可空   | 单位:元(最多保留 2 位小数)                                   |
| - tax_rate       | 税率               |                  | 税率                           | 不可空   | 例 17%为 0.17。小数点 后最末位不能为零，例 10%为 0.1。       |
| - tax_price      | 税额               | String(12)       | 税额                           | 不可空   | 单位:元(最多保留 2 位小数) 校验:金额*税率=税额 误差正负 0.06 |
| - num            | 数量               | String(20)       | 数量                           | 可空     | 总长度包含小数点不 能超过 20 位。                            |
| - unit_price     | 单价               | String(20)       | 单价                           | 可空     | 不含税，总长度包含小 数点不能超过 20 位。<br>(只有当 征税方式为`减按计征`时， 此处填含税单价) |
| - product_code   | 商品编码           | String(19)       | 商品编码                       | 可空     | 税局下发的商品编码 表中最末级节点的编 码                     |
| - self_code      | 自行编码           | String(20)       | 自行编码                       | 可空     | 未填写商品编码时，须 使用自行增加的项目 名称，并填写该商品的 编码至自行编码中。 |
| - offer_sign     | 优惠标识           | Number           | 优惠标识                       | 可空     | `0` - 不使用，`1` - 使用                                     |
| - zero_sign      | 零税率标识         | Number           | 零税率标识                     | 可空     | 空:非零税率， `1` - 免 税，`2` - 不征收，`3` - 普通零税率    |
| - special        | 增值税特殊管理     | String(50)       | 增值税特殊管理                 | 可空     | 若含有预售卡业务，税率为 0，零税率标示必 须为不征税，优惠政策 标示为 1，增值税特殊 管理必须为不征税 |
| - spec_model     | 规格型号           | String(40)       | 规格型号                       | 可空     |                                                              |
| - unit           | 单位               | String(20)       | 单位                           | 可空     |                                                              |
| - spare_1        | 备用               | String(200)      | 备用                           | 可空     |                                                              |
|                  |                    |                  |                                |          |                                                              |
| sign             | 交易签名           | String(64)       | 商户签名                       | 不可空   | 商户发送的MD5数字签名，如：`sign=b309bff0edac2aa6e3ea7a2e9af7c940`。 |

### 应答结果

应答为一个JSON报文。报文的编码格式为UTF-8。其中/root/record下面的节点参与签名。/root/record下所有的子节点，名称和值组成一个待签名的数组。

|      |             | 参数 | 参数名称 | 类型（最大长度） | 参数说明   | 是否可空 | 描述                          |
| ---- | ----------- | ---- | -------- | ---------------- | ---------- | -------- | ----------------------------- |
| root |             |      |          |                  |            |          |                               |
|      | result_code |      | 应答码   | String(4)        | 查看应答码 | 不可空   | `0000`：成功<br/>`其他`：失败 |
|      | result_msg  |      | 应答信息 | String(100)      |            | 可空     | 应答信息                      |

### 举例

```json
// success
{
  "result_code": "0000",
  "result_msg": "成功"
}

// failed
{
"result_code": "900001",
"result_msg": "***"
}
```



# 2 发票红冲

### 功能说明

提供发票红冲功能。

### 请求地址

```
/invoice/clearOut
```

### 接口方式

表单请求(POST)，JSON应答，字符集为UTF-8。

### 请求参数

!>默认参数与`发票开具`相同，下方是该接口新增参数

| 参数              | 参数名称         | 类型（最大长度） | 参数说明                                 | 是否可空 | 描述                                                   |
| ----------------- | ---------------- | ---------------- | ---------------------------------------- | -------- | ------------------------------------------------------ |
| contrast_order_id | 原发票申请流水号 | String(32)       | 原发票申请返回的内部流水号（`order_id`） | 不可空   | 开红字发票时对应的原蓝票订单，开票类型为红字发票时必填 |

### 应答结果

应答为一个JSON报文。报文的编码格式为UTF-8。其中/root/record下面的节点参与签名。/root/record下所有的子节点，名称和值组成一个待签名的数组。

|      |             | 参数 | 参数名称 | 类型（最大长度） | 参数说明   | 是否可空 | 描述                          |
| ---- | ----------- | ---- | -------- | ---------------- | ---------- | -------- | ----------------------------- |
| root |             |      |          |                  |            |          |                               |
|      | result_code |      | 应答码   | String(4)        | 查看应答码 | 不可空   | `0000`：成功<br/>`其他`：失败 |
|      | result_msg  |      | 应答信息 | String(100)      |            | 可空     | 应答信息                      |

### 举例

```json
// success
{
  "result_code": "0000",
  "result_msg": "成功"
}

// failed
{
"result_code": "900001",
"result_msg": "***"
}
```



# 3 获取开票状态

### 功能说明

获取发票信息。

### 请求地址

```
/invoice/query
```

### 接口方式

表单请求(POST)，JSON应答，字符集为UTF-8。

### 请求参数

| 参数         | 参数名称         | 类型（最大长度） | 参数说明               | 是否可空 | 描述                                                         |
| ------------ | ---------------- | ---------------- | ---------------------- | -------- | ------------------------------------------------------------ |
| mer_order_id | 原发票申请订单号 | String(32)       | 原发票申请订单号       | 不可空   | 如：`mer_order_id=20110101XX`                                |
| mer_code     | 商户编号         | String(32)       | 奇虎分配给商户的ID号码 | 不可空   | 如：`mer_code=201111360`。                                   |
| timestamp    | 时间戳           | Number           | 请求时间戳             | 不可空   | Unix timestamp，超时时间为86400。                            |
| sign         | 交易签名         | String(64)       | 商户签名               | 不可空   | 商户发送的MD5数字签名，如：`sign=b309bff0edac2aa6e3ea7a2e9af7c940`。 |

### 应答结果

应答为一个JSON报文。报文的编码格式为UTF-8。其中/root/record下面的节点参与签名。/root/record下所有的子节点，名称和值组成一个待签名的数组。

|      |             | 参数         | 参数名称         | 类型（最大长度） | 参数说明                                | 是否可空 | 描述                                                         |
| ---- | ----------- | ------------ | ---------------- | ---------------- | --------------------------------------- | -------- | ------------------------------------------------------------ |
| root |             |              |                  |                  |                                         |          |                                                              |
|      | result_code |              | 应答码           | String(4)        | 查看应答码                              | 不可空   | `0000`：成功<br/>`其他`：失败                                |
|      | result_msg  |              | 应答信息         | String(100)      |                                         | 可空     | 应答信息                                                     |
|      | record      |              |                  |                  |                                         |          |                                                              |
|      |             | mer_order_id | 原发票申请订单号 | String(32)       | 原发票申请订单号                        | 可空     | 如：`"mer_order_id":"20110101XX"`<br>成功必填                |
|      |             | order_id     | 订单流水号       | String(20)       | 本次订单内部流水号                      | 可空     | 如：`"order_id":"2019112845B4646034XX"`<br/>成功必填         |
|      |             | invoice_code | 发票代码         | String(12)       | 发票代码                                | 可空     | 如：`"invoice_code":"152000186357"`<br/>成功必填             |
|      |             | invoice_no   | 发票号码         | String(8)        | 发票号码                                | 可空     | 如：`"invoice_no":"30428494"`<br/>成功必填                   |
|      |             | verify_code  | 校验码           | String(20)       | 校验码                                  | 可空     | 如：`"verify_code":"03614397069843161007"`<br/>成功必填      |
|      |             | success_time | 开票日期         | String(14)       | 开票日期                                | 可空     | 如：`"success_time":"2019-11-28 11:32:03"`<br/>成功必填      |
|      |             | download_url | PDF 下载地址     | String(200)      | PDF 下载地址                            | 可空     | 如：`"download_url":"http://dev.fapiao.com:19080/dzfp-web/pdf/download?request=e***"`<br/>成功必填 |
|      |             | receipt_url  | 收票地址         | String(250)      | 用该地址生成二维码，供用 户扫码获取发票 | 可空     | 如：`"receipt_url":"https://testwx.fapiao.com/fpt-wechat/wxaddcard.do?code=SQlUxrpMKJe***"`<br/>成功必填 |

### 举例

```json
// success
{
  "result_code": "0000",
  "result_msg": "成功",
  "data": "{\"mer_order_id\":\"2810d139-0a6a-4be3-bc55-63505179eaec\",\"order_id\":\"2019112845B464603409\",\"invoice_code\":\"152000186357\",\"invoice_no\":\"30428494\",\"verify_code\":\"03614397069843161007\",\"success_time\":\"2019-11-28 11:32:03\",\"download_url\":\"http:\\\/\\\/dev.fapiao.com:19080\\\/dzfp-web\\\/pdf\\\/download?request=e5uhf8WETIOMgaa2cCUMtvvTi9dFVwPEW4E9Av0TqWz9Y8KtUC3yo18UYT3Zp7OiFVboIAcyBhKOgpJXChyq8w__%5EdhhEEdjCdc\",\"receipt_url\":\"https:\\\/\\\/testwx.fapiao.com\\\/fpt-wechat\\\/wxaddcard.do?code=SQlUxrpMKJeRPqER1txIamMGLTKmO8mqiJnKNTf9%2F3aTqw%2FfsCK5TexZN1H2XgO%2Bj3GNilk06GBI%0AgMSdzo4NBA%3D%3D\"}"
}

// failed
{
"result_code": "900001",
"result_msg": "***"
}
```



# 4 数字签名描述

## 4.1 生成待签名的字符串

### 需要签名的参数

在请求参数列表中，除去sign这个参数外，其他需要使用到的参数皆是要签名的参数。在通知返回参数列表中，除去sign这个参数外，凡是通知返回回来的参数皆是要签名的参数。

### 生成待签名的字符串

对于如下的参数数组：

```text
apply_time=1575449775
invoice_title=个人||北京奇虎科技有限公司
item_details=[{"nature":"0","product_code":"1010101030000000000","name":"谷物","price_tax":"5","price":"4.7","tax_rate":"0.06","tax_price":"0.3"}]
mer_code=20111117360
mer_order_id=2eb195b5-17dc-48ea-b17a-fd8ef244f1a6
tax_register_no=110109500321655
tax_type=0
total_price=4.7
total_price_tax=5
total_tax_price=0.3
user_email=dasd@qq.com
user_id=161050013
user_type=0
```

对数组里的每一个值从a到z的顺序排序，若遇到相同首字母，则看第二个字母，以此类推。
排序完成之后，再把所有数组值以“&”字符连接起来，如：

```text
apply_time=1575449775&invoice_title=个人||北京奇虎科技有限公司&item_details=[{"nature":"0","product_code":"1010101030000000000","name":"谷物","price_tax":"5","price":"4.7","tax_rate":"0.06","tax_price":"0.3"}]&mer_code=20111117360&mer_order_id=2eb195b5-17dc-48ea-b17a-fd8ef244f1a6&tax_register_no=110109500321655&tax_type=0&total_price=4.7&total_price_tax=5&total_tax_price=0.3&user_email=dasd@qq.com&user_id=161050013&user_type=0
```

这串字符串便是待签名字符串。

### 注意事项

1. 没有值的参数无需传递，也无需包含到待签名数据中；
2. 签名时将字符转化成字节流时指定的字符集与input_cha保持一致；
3. 根据HTTP协议要求，传递参数的值中如果存在特殊字符（如：&、@等），那么该值需要做URL Encoding，这样请求接收方才能接收到正确的参数值。这种情况下，待签名数据应该是原生值而不是encoding之后的值。例如：调用某接口需要对请求参数email进行数字签名，那么待签名数据应该是`email=test@msn.com`，而不是email=test%40msn.com。

### MD5签名

商户开户后，会得到一个商户号（`mer_code`）和一个做MD5的`私钥`，请商户妥善保存此私钥。验证签名时，将私钥拼接到代签名字符串后面，形成新的字符串，利用MD5算法对这个新的字符串进行签名运算，从而得到32位的签名结果字符串。

## 4.2 签名示例代码

### PHP

```php
function sign ($params,$key)
{
    ksort($params);
    reset($params);
    $sign = '';
    foreach ($params as $index => $value)
    {
        if ('sign' == $index || ''==$value)
        {
            continue;
        }
        $sign.= $index.'='.$value.'&';
    }
    $sign = rtrim($sign, '&').$key;
    $sign_value = md5($sign);
    
    return $sign_value;
}
```

# 5 附录

## 5.1 应答码字典

| 应答码 | 说明                                               |
| ------ | -------------------------------------------------- |
| 0000   | 交易成功                                           |
| 900002 | 必要字段为空 也可以理解成传入的参数有问题， 请检查 |
| 900003 | 金额为负数或非法                                   |
| 900004 | 请求过期                                           |
| 900005 | 请求字段不合法                                     |
| 900006 | 请求订单详情为空                                   |
| 900007 | 请求订单详情必填参数为空                           |
| 900008 | 请求开票红票mer_trade_code字段应为空               |
| 900009 | 请求开票mer_trade_code订单未支付成功               |
| 900010 | 开票额度不足                                       |
| 900011 | 账户开票余票不足                                   |
| 900012 | 开红票，查询蓝票流水不存在                         |
| 900013 | 商户订单号重复                                     |
| 900014 | 开票入库失败                                       |
| 900015 | 申请开票失败或返回订单号不同user_type              |
| 900016 | user_type                                          |
| 900017 | 数据库异常                                         |
| 900018 | 未配置渠道道配置信息或未开通                       |
| 900019 | 对应商户权限未开通或未配置                         |
| 900020 | 签名错误                                           |
| 900021 | 未查到请求开票记录                                 |
| 900022 | 获取发票状态失败                                   |
